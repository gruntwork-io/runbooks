# Updates the Homebrew formula in gruntwork-io/homebrew-tap on each release.
#
# SYNC NOTE: The formula generation logic in the "Generate formulae" step is
# duplicated in homebrew-tap's test-homebrew-workflow.sh. If you change it
# here, update the test script too. See "Keeping the test script in sync" in
# that repo's README.

name: Update Homebrew Formula

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  update-homebrew:
    runs-on: ubuntu-latest

    env:
      # The subcommand/flag used to print the version (for the formula test block).
      VERSION_CMD: "version"

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.HOMEBREW_TAP_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_TAP_APP_PRIVATE_KEY }}
          owner: gruntwork-io
          repositories: homebrew-tap

      - name: Download release binaries
        id: download
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          TOOL_NAME="${GITHUB_REPOSITORY#*/}"
          mkdir -p /tmp/binaries
          for platform in darwin_arm64 darwin_amd64 linux_arm64 linux_amd64; do
            gh release download "$TAG" \
              --repo "$GITHUB_REPOSITORY" \
              --pattern "${TOOL_NAME}_${platform}" \
              --dir /tmp/binaries
          done
          echo "tool_name=${TOOL_NAME}" >> "$GITHUB_OUTPUT"

      - name: Compute SHA256 checksums
        id: checksums
        env:
          TOOL_NAME: ${{ steps.download.outputs.tool_name }}
        run: |
          for platform in darwin_arm64 darwin_amd64 linux_arm64 linux_amd64; do
            sha=$(sha256sum "/tmp/binaries/${TOOL_NAME}_${platform}" | cut -d' ' -f1)
            echo "sha_${platform}=${sha}" >> "$GITHUB_OUTPUT"
          done

      - name: Clone homebrew-tap
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/gruntwork-io/homebrew-tap.git" /tmp/homebrew-tap

      - name: Generate formulae
        env:
          TAG: ${{ github.event.release.tag_name }}
          TOOL_NAME: ${{ steps.download.outputs.tool_name }}
          SHA_DARWIN_ARM64: ${{ steps.checksums.outputs.sha_darwin_arm64 }}
          SHA_DARWIN_AMD64: ${{ steps.checksums.outputs.sha_darwin_amd64 }}
          SHA_LINUX_ARM64: ${{ steps.checksums.outputs.sha_linux_arm64 }}
          SHA_LINUX_AMD64: ${{ steps.checksums.outputs.sha_linux_amd64 }}
        run: |
          cd /tmp/homebrew-tap

          FORMULA_FILE="Formula/${TOOL_NAME}.rb"
          if [[ ! -f "$FORMULA_FILE" ]]; then
            echo "::error::Formula ${FORMULA_FILE} not found. Create it in homebrew-tap first."
            exit 1
          fi

          DESC=$(grep '^\s*desc ' "$FORMULA_FILE" | head -1 | sed 's/.*desc "\(.*\)"/\1/')
          HOMEPAGE=$(grep '^\s*homepage ' "$FORMULA_FILE" | head -1 | sed 's/.*homepage "\(.*\)"/\1/')
          LICENSE=$(grep '^\s*license ' "$FORMULA_FILE" | head -1 | sed 's/.*license "\(.*\)"/\1/')

          CLASS_NAME=$(echo "$TOOL_NAME" | perl -pe 's/(^|[-_])(\w)/uc($2)/ge')

          SEMVER=$(echo "$TAG" | sed -E 's/^[a-zA-Z]*-?v?//' | sed -E 's/-.*//')
          VERSIONED_CLASS="${CLASS_NAME}AT$(echo "$SEMVER" | tr -d '.')"

          generate_formula() {
            local class="$1"
            cat <<FORMULA
          class ${class} < Formula
            desc "${DESC}"
            homepage "${HOMEPAGE}"
            version "${TAG}"
            license "${LICENSE}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/gruntwork-io/${TOOL_NAME}/releases/download/${TAG}/${TOOL_NAME}_darwin_arm64"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "https://github.com/gruntwork-io/${TOOL_NAME}/releases/download/${TAG}/${TOOL_NAME}_darwin_amd64"
                sha256 "${SHA_DARWIN_AMD64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/gruntwork-io/${TOOL_NAME}/releases/download/${TAG}/${TOOL_NAME}_linux_arm64"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "https://github.com/gruntwork-io/${TOOL_NAME}/releases/download/${TAG}/${TOOL_NAME}_linux_amd64"
                sha256 "${SHA_LINUX_AMD64}"
              end
            end

            def install
              binary = Dir["${TOOL_NAME}_*"].first
              bin.install binary => "${TOOL_NAME}"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/${TOOL_NAME} ${VERSION_CMD}")
            end
          end
          FORMULA
          }

          generate_formula "$CLASS_NAME" > "$FORMULA_FILE"
          generate_formula "$VERSIONED_CLASS" > "Formula/${TOOL_NAME}@${SEMVER}.rb"

      - name: Open PR
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          TAG: ${{ github.event.release.tag_name }}
          TOOL_NAME: ${{ steps.download.outputs.tool_name }}
        run: |
          cd /tmp/homebrew-tap
          BRANCH="update-${TOOL_NAME}-${TAG}"

          git checkout -b "$BRANCH"
          git add Formula/

          # If the formulae already match main (e.g., a previous run's PR was merged),
          # there is nothing left to do.
          if git diff --cached --quiet; then
            echo "Formula is already up to date on main â€” nothing to do."
            exit 0
          fi

          git \
            -c user.name="gruntwork-homebrew-tap[bot]" \
            -c user.email="gruntwork-homebrew-tap[bot]@users.noreply.github.com" \
            commit -m "Update ${TOOL_NAME} to ${TAG}"
          git push --force-with-lease origin "$BRANCH"

          # Re-use an existing PR if one was already opened for this branch.
          EXISTING_PR=$(gh pr list \
            --repo gruntwork-io/homebrew-tap \
            --head "$BRANCH" \
            --json url \
            --jq '.[0].url // empty')

          if [[ -n "$EXISTING_PR" ]]; then
            PR_URL="$EXISTING_PR"
            echo "PR already exists: ${PR_URL}"
          else
            PR_URL=$(gh pr create \
              --repo gruntwork-io/homebrew-tap \
              --base main \
              --head "$BRANCH" \
              --title "Update ${TOOL_NAME} to ${TAG}" \
              --body "Automated formula update for **${TOOL_NAME}** to [\`${TAG}\`](https://github.com/gruntwork-io/${TOOL_NAME}/releases/tag/${TAG}).")
          fi

          gh pr merge "$PR_URL" \
            --repo gruntwork-io/homebrew-tap \
            --auto \
            --merge
