# Create the infrastructure-live-root repo

In this Runbook, we'll create the `infrastructure-live-root` repo.

As a reminder, here's what the `infrastructure-live-root` repo is:

- **Purpose:** Manage your AWS organization, manage "central" AWS accounts, create new AWS accounts.
- **Access:** This repo will have broad access to your entire cloud footprint, including AWS and other clouds.
- **Users:** This repo is typically restricted to a small group of trusted users.

## Pre-flight checks

Before we get started, let's make sure your local system is ready to go.

<Admonition type="info" title="Pre-flight checks" description="Let's make sure your local system is ready to go." />

<Check 
    id="check-gh-install" 
    path="checks/gh-install.sh" 
    title="Check if the GitHub CLI is installed"
    description="`gh` is the [GitHub CLI tool](https://cli.github.com/) that makes it easy to interact with GitHub from the command line. We'll use it create repos and pull requests."
    successMessage="`gh` is installed and ready to go!"
    failMessage="`gh` is not installed. Please install it to continue!"
/>

<Command 
    id="install-gh-latest-version"
    path="scripts/upgrade-gh-to-latest.sh"
    title="Upgrade to the latest version of `gh`"
    description="Let's make sure you have the latest version of `gh` installed!"
    successMessage="`gh` is up to date!"
    failMessage="Failed to upgrade `gh` to the latest version."
/>

<Check id="check-mise-install" 
    path="checks/mise-install.sh" 
    title="Check if `mise` is installed"
    description="Mise is an open source CLI tool that makes it easy to install all required tools for your IaC repos from the command line. Learn more at https://mise.jdx.dev/."
    successMessage="`mise` is installed and ready to go!"
    failMessage="Mise is not installed. Please [install it](https://mise.jdx.dev/getting-started.html) to continue!"
/>

## Create the repo

Now let's create the `infrastructure-live-root` repo.

<Command id="create-infrastructure-live-root-repo"
    command="gh repo create {{ .GithubOrgName }}/{{ .GithubRepoName }} --private"
    title="Create the `infrastructure-live-root` repo"
    description="This will create a new private repo in your GitHub organization."
    successMessage="`infrastructure-live-root` repo created successfully!"
    failMessage="Failed to create the `infrastructure-live-root` repo."
>
    <Inputs id="infrastructure-live-root-repo-inputs">
    ```yaml
    variables:
    - name: GithubOrgName
      type: string
      description: The GitHub org where we'll create the repo.
      validations: "required"
    - name: GithubRepoName
      type: string
      description: The name of your `infrastructure-live-root` repo
      default: "infrastructure-live-root"
      validations: "required"
    ```
    </Inputs>
</Command>

Let's double check that the repo was created successfully.

<Check id="check-infrastructure-live-root-repo"
    command="gh repo view {{ .GithubOrgName }}/{{ .GithubRepoName }}"
    inputsId="infrastructure-live-root-repo-inputs"
    title="Confirm the repo was created successfully"
    description="Let's make sure the repo was created successfully."
    successMessage="Repo confirmed!"
    failMessage="Your repo does not appear to exist. Please check the inputs and try again."
/>

## Pouplate the repo

Now it's time to populate the repo with the necessary files.

### Look up the latest versions of OpenTofu and Terragrunt

Presumably, you'd like to use the latest versions of OpenTofu and Terragrunt. Let's look them up.

<Command id="lookup-latest-versions-of-opentofu-and-terragrunt"
    command={'echo "OpenTofu: $(mise ls-remote opentofu | tail -1)" && echo "Terragrunt: $(mise ls-remote terragrunt | tail -1)"'}
    title="Lookup the latest versions of OpenTofu and Terragrunt"
    description="Let's look up the latest versions of OpenTofu and Terragrunt."
    successMessage="Latest versions of OpenTofu and Terragrunt looked up successfully!"
    failMessage="Failed to lookup the latest versions of OpenTofu and Terragrunt."
/>

Now copy and paste the values above into the form below.

### Create `.mise.yml`

<Inputs id="test1">
```yaml
variables:
- name: Name
  order: 1
  description: Your name
  type: string
  validations: required
```
</Inputs>

<Command id="test-command1"
    command="echo 'Hello, {{.Name}}'"
    inputsId="test1"
    title="Create a pull request with the changes"
    description="This will clone your repo, add all the generated files, commit them, push to a new branch, and create a pull request."
    successMessage="Pull request created successfully!"
    failMessage="Failed to create the pull request."
/>

<Template id="mise-config-inputs" path="templates/mise-config" />

We just created the `.mise.toml` file. We're going to use this shortly in your new repo!

Here's a preview of the GitHub Actions workflow we'll add to your repo:

<TemplatePreview inputsId="infrastructure-live-root-repo-inputs" outputPath="ci.yml" generateFile={true}>
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: {{ .GithubOrgName }}/{{ .GithubRepoName }}
      
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
      
      - name: Validate
        run: tofu validate
```
</TemplatePreview>

### Create Terragrunt foundations

Now let's generate a bunch of files that will lay a solid foundation for your new repo with Terragrunt.

<Template id="infra-live-elements-inputs" path="templates/infra-live-elements" />

### Create a pull request with the changes

<Command id="create-pull-request-with-changes"
    path="scripts/create-initial-pr.sh"
    inputsId="infrastructure-live-root-repo-inputs"
    title="Create a pull request with the changes"
    description="This will clone your repo, add all the generated files, commit them, push to a new branch, and create a pull request."
    successMessage="Pull request created successfully!"
    failMessage="Failed to create the pull request."
/>

### Congratulations!

You've created the `infrastructure-live-root` repo and added the necessary files to it.

## Next steps

Now that you've created the `infrastructure-live-root` repo, let's move on to the next runbook where we'll create the `infrastructure-live-access-control` repo.

Open the next Runbook: 

```bash
runbooks open testdata/demo-runbook-3/runbook.mdx
</Command>