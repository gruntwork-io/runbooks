# Deploy an AWS Lambda Function with Terragrunt

This runbook guides you through creating a new AWS Lambda function using Terragrunt and the [Lambda module](https://github.com/gruntwork-io/terragrunt-infrastructure-catalog-example/tree/main/modules/lambda-service) from the Terragrunt Infrastructure Catalog Example.

## What you'll deploy

You'll deploy a Terragrunt unit configuration for the Lambda function that includes:

1. A Lambda function
2. Source code for a Lambda handler function
3. The relevant IAM roles and policies for the Lambda function

We'll then guide you on how to test the Lambda function locally using [SAM](https://aws.amazon.com/serverless/sam/) and how to deploy it to AWS.

![Lambda Function Architecture](./assets/lambda-function.png)

## Pre-flight checks

Before you begin, ensure you have the required tools installed and are properly authenticated.

### Install mise

First, verify that mise is installed. If not, install it from [mise.jdx.dev](https://mise.jdx.dev/getting-started.html).

<Check
  id="check-mise"
  command="mise --version"
  title="Check mise Installation"
  description="mise is a polyglot tool version manager that can install and manage Terragrunt, OpenTofu, and other tools"
  successMessage="mise is installed!"
  failMessage="mise is not installed. Install it from https://mise.jdx.dev/getting-started.html"
/>

### Install Required Tools

Once mise is installed, run the following command to install all required tools:

<Command
  id="install-tools"
  command="mise use -g terragrunt@latest opentofu@latest awscli@latest granted@latest"
  title="Install Required Tools via mise"
  description="Installs Terragrunt, OpenTofu, AWS CLI, and Granted using mise"
  successMessage="All tools installed successfully!"
  failMessage="Failed to install tools. Check the logs for details."
/>

## Generate the Terragrunt Unit

Now it's time to generate the code for a **Terragrunt unit** that deploys the Lambda function.

### What's a Terragrunt Unit?

The pattern we will use for defining a Lambda function is already authored in this [OpenTofu/Terraform Lambda module](https://github.com/gruntwork-io/terragrunt-infrastructure-catalog-example/tree/main/modules/lambda-service).

To launch an _instance_ of that module with its own unique configuration values and Lambda function, we will create a Terragrunt unit, which is a file read by [Terragrunt](https://terragrunt.gruntwork.io/) that will download the OpenTofu/Terraform module, pass in the values from the Terragrunt unit, and deploy it using OpenTofu/Terraform.

### Configure the Lambda Function

First, let's configure the Lambda function itself. This is boilerplate code that will run "Hello, World!" when the Lambda function is invoked.

<BoilerplateInputs
  id="lambda-config"
  templatePath="templates/lambda-unit"
/>

The generated files will include:
- `terragrunt.hcl` - Terragrunt unit configuration
- `src/app.py` - Python Lambda handler with logging, error handling, and API Gateway support

## Create Pull Request

Once the files are generated, create a pull request to add them to your infrastructure repository.

<Command
  id="create-pr"
  command="scripts/create-initial-pr.sh"
  title="Create Pull Request"
  description="Creates a pull request with the generated Lambda configuration in {{ .Environment }}/{{ .AwsRegion }}/{{ .FunctionName }}/"
  successMessage="Pull request created successfully!"
  failMessage="Failed to create pull request. Make sure you have the GitHub CLI (gh) installed and authenticated."
  inputsFrom="lambda-config"
/>

## Next Steps

Congratulations! Your Lambda function has been deployed. Here are some next steps:

1. **Move generated files**: Copy the generated files from `generated/` to your desired location in the repo (e.g., `non-prod/us-east-1/my-lambda/`)
2. **Test the function**: Use the AWS Console or CLI to invoke your Lambda function
3. **Add triggers**: Configure API Gateway, S3, SNS, or other event sources
4. **Set up monitoring**: Configure CloudWatch alarms and logging
5. **Configure environment variables**: Add secrets and configuration via AWS Systems Manager Parameter Store

### Useful Commands

```bash
# Move generated files to your repo structure
mv generated/ {{ .Environment }}/{{ .AwsRegion }}/{{ .FunctionName }}/

# Invoke the Lambda function
aws lambda invoke --function-name {{ .FunctionName }}-{{ .Environment }} \
  --region {{ .AwsRegion }} \
  --payload '{"test": "event"}' \
  response.json

# View CloudWatch logs
aws logs tail /aws/lambda/{{ .FunctionName }}-{{ .Environment }} --follow

# Destroy the infrastructure (if needed)
cd {{ .Environment }}/{{ .AwsRegion }}/{{ .FunctionName }} && terragrunt destroy
```

