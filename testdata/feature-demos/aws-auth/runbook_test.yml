# Test configuration for aws-auth
# Tests the AWS authentication testing framework with testPrefix support.
#
# To run locally:
#   export RUNBOOKS_TEST_AWS_ACCESS_KEY_ID=...
#   export RUNBOOKS_TEST_AWS_SECRET_ACCESS_KEY=...
#   export RUNBOOKS_TEST_AWS_SESSION_TOKEN=...  # if using temp creds
#   export RUNBOOKS_TEST_AWS_REGION=us-west-2
#   go run main.go test testdata/feature-demos/aws-auth -v
#
# Or use AWS profile:
#   export AWS_PROFILE=your-profile
#   go run main.go test testdata/feature-demos/aws-auth -v

version: 1

settings:
  use_temp_working_dir: true
  timeout: 2m
  parallelizable: true

tests:
  # Test 1: Basic auth with testPrefix - validates the testPrefix feature
  - name: test-prefix-auth
    description: Test that AwsAuth reads credentials from RUNBOOKS_TEST_* env vars

    steps:
      # This block has detectCredentials={[{ env: { testPrefix: 'RUNBOOKS_TEST_' } }]}
      # So the test executor should look for RUNBOOKS_TEST_AWS_ACCESS_KEY_ID, etc.
      - block: aws-auth
        expect: success

      # After AwsAuth succeeds, credentials should be injected into the session
      # and this Check block should be able to use them
      - block: verify-identity
        expect: success

  # Test 2: Skip auth when no credentials - validates graceful skip
  - name: skip-without-credentials
    description: Test that AwsAuth is skipped when no credentials are available
    
    env:
      # Clear any credentials that might be in the environment
      RUNBOOKS_TEST_AWS_ACCESS_KEY_ID: ""
      RUNBOOKS_TEST_AWS_SECRET_ACCESS_KEY: ""
      AWS_ACCESS_KEY_ID: ""
      AWS_SECRET_ACCESS_KEY: ""
      AWS_PROFILE: ""
      AWS_ROLE_ARN: ""

    steps:
      - block: aws-auth
        expect: skip

  # Test 3: AWS auth secondary test (single auth block)
  - name: test-aws-auth-secondary
    description: Test that AwsAuth secondary passes its credentials to the Command block

    steps:
      - block: aws-auth-secondary
        expect: success

      - block: list-buckets-secondary
        expect: success

  # Test 4: Multi-account credential isolation
  # This test authenticates BOTH auth blocks with different credentials,
  # then verifies that each Check uses the correct credentials via awsAuthId.
  - name: test-multi-account-isolation
    description: Test that credentials are properly isolated when multiple auth blocks are used

    steps:
      # First, authenticate the primary account (uses RUNBOOKS_TEST_* prefix)
      - block: aws-auth
        expect: success

      # Then, authenticate the secondary account (uses standard AWS_* vars)
      - block: aws-auth-secondary
        expect: success

      # This Check has awsAuthId="aws-auth" - should use PRIMARY credentials
      - block: list-buckets-primary
        expect: success

      # This Check has awsAuthId="aws-auth-secondary" - should use SECONDARY credentials
      - block: list-buckets-secondary
        expect: success
