# Test configuration for lambda runbook
# This runbook interacts with external services (GitHub, AWS, Terragrunt).
# Currently only testing template generation; script tests to be added in future PR.

version: 1

settings:
  use_temp_working_dir: true
  timeout: 5m
  parallelizable: true

tests:
  - name: template-validation
    description: Validate template generation without external service calls

    inputs:
      lambda-config.Environment: "non-prod"
      lambda-config.AwsRegion: "us-east-1"
      lambda-config.FunctionName: "test-function"
      lambda-config.Description: "Test Lambda function"
      lambda-config.Runtime: "python3.12"
      lambda-config.Handler: "app.handler"
      lambda-config.LogLevel: "INFO"
      lambda-config.MemorySize: 128
      lambda-config.Timeout: 30
      lambda-config.ReservedConcurrency: 10
      repo-config.GithubOrgName: "test-org"
      repo-config.GithubRepoName: "test-repo"

    steps:
      - block: aws-auth
        expect: skip
      - block: check-mise
        expect: skip
      - block: install-tools
        expect: skip
      - block: lambda-config
        expect: success
      - block: create-pr
        expect: skip
      - block: terragrunt-plan
        expect: skip
      - block: terragrunt-apply
        expect: skip
      - block: test-function
        expect: skip

    assertions:
      - type: files_generated
        block: lambda-config
        min_count: 1
      - type: file_exists
        path: terragrunt.hcl
      - type: file_contains
        path: terragrunt.hcl
        contains: "test-function"
      - type: file_exists
        path: src/app.py
